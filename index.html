<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
      name="viewport"
    />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#B8FF00",
              "bg-dark": "#1E1E1E",
              "muted-gray": "#555555",
              "card-dark": "#111111",
              "accent-red": "#FF3B30",
            },
            fontFamily: {
              sans: ["Onest", "sans-serif"],
            },
            borderRadius: {
              "2xl": "1rem",
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      body {
        background-color: #1e1e1e;
        color: white;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        overflow: hidden;
        height: 100dvh;
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
      .ios-active:active {
        transform: scale(0.97);
        transition: transform 0.1s ease;
      }
      .screen {
        display: none;
      }
      .screen.active {
        display: block;
      }
      .toast {
        position: fixed;
        left: 50%;
        bottom: 24px;
        transform: translateX(-50%);
        background: #0f0f0f;
        border: 1px solid #b8ff00;
        color: #d6ff7a;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.18s ease;
      }
      .toast.show {
        opacity: 1;
      }
    </style>
  </head>
  <body class="flex flex-col p-6">
    <section id="screen-locked" class="screen">
      <div class="h-full flex flex-col items-center justify-center text-center">
        <div class="text-2xl font-bold mb-2">Доступ закрыт</div>
        <div class="text-muted-gray">Вход только по приглашению.</div>
      </div>
    </section>
    <header id="appHeader" class="pt-2 mb-6 flex items-center gap-3">
      <img
        src="ghost_ava.png"
        alt="GhostLink"
        class="w-10 h-10 rounded-full object-cover"
      />
      <div class="flex-1">
        <h1 class="text-3xl font-black tracking-tight text-white uppercase">
          GHOSTLINK
        </h1>
      </div>
      <button id="backBtn" class="hidden text-white/80">Назад</button>
    </header>

    <main class="flex-1 overflow-y-auto">
      <section id="screen-home" class="screen active">
        <div class="mt-2 grid grid-cols-2 gap-x-6 gap-y-1 mb-8 items-start">
          <span class="text-white text-[28px] font-bold leading-none" id="balanceValue">0₽</span>
          <span class="text-white text-lg font-bold leading-none text-right" id="expiryValue">нет подписки</span>
          <div class="min-h-[16px] flex items-end">
            <span class="text-muted-gray text-[20px] font-black uppercase tracking-wider">Баланс</span>
          </div>
          <div class="min-h-[16px] flex items-end justify-end">
            <span id="subStatus" class="text-[10px] font-black uppercase tracking-wider text-accent-red"
              >ПОДПИСКА НЕАКТИВНА</span
            >
          </div>
        </div>

        <div class="flex flex-col gap-4">
          <button id="buyBtn"
            class="ios-active w-full bg-primary h-[60px] rounded-2xl flex items-center justify-between px-6"
          >
            <span class="text-black font-bold text-lg">Поддержать проект</span>
            <span class="material-symbols-outlined text-black">favorite</span>
          </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4">
          <button id="profileBtn"
            class="ios-active border border-primary h-[80px] rounded-2xl flex flex-col items-center justify-center gap-1"
          >
            <span class="material-symbols-outlined text-primary">person</span>
            <span class="text-primary text-sm font-bold">Профиль</span>
          </button>
          <button id="supportBtn"
            class="ios-active border border-primary h-[80px] rounded-2xl flex flex-col items-center justify-center gap-1"
          >
            <span class="material-symbols-outlined text-primary">headset_mic</span>
            <span class="text-primary text-sm font-bold">Поддержка</span>
          </button>
        </div>
        <button id="homeAdminBtn"
          class="hidden ios-active mt-4 w-full border border-primary h-[52px] rounded-2xl flex items-center justify-center gap-2"
        >
          <span class="material-symbols-outlined text-primary">admin_panel_settings</span>
          <span class="text-primary font-bold">Админка</span>
        </button>
      </section>

      <section id="screen-tariffs" class="screen">
        <h2 class="text-2xl font-bold mb-4">Поддержка сервиса</h2>
        <div class="border border-primary rounded-2xl p-4 mb-4">
          <div class="text-white text-lg font-bold">Solo Ghost</div>
          <div class="text-muted-gray text-sm">1 устройство</div>
          <div class="mt-3">
            <button id="soloPay" class="ios-active bg-primary text-black font-bold px-4 py-2 rounded-xl w-full">1 месяц — 150 ₽</button>
          </div>
        </div>

        <div class="border border-primary rounded-2xl p-4">
          <div class="text-white text-lg font-bold">Flex Squad</div>
          <div class="text-muted-gray text-sm">Выбери количество устройств</div>
          <div class="mt-3">
            <input id="flexSlider" type="range" min="2" max="5" value="2" class="w-full">
            <div class="flex justify-between text-xs text-muted-gray mt-1">
              <span>2</span><span>3</span><span>4</span><span>5</span>
            </div>
          </div>
          <div class="mt-3 text-white" id="flexPrice">2 устройства — 225 ₽</div>
          <button id="flexPay" class="ios-active bg-primary text-black font-bold px-4 py-2 rounded-xl w-full mt-3">Поддержать</button>
        </div>

        <div class="text-muted-gray text-sm mt-4">Оплата будет подключена позже.</div>
      </section>

      <section id="screen-profile" class="screen">
        <div class="mb-4">
          <div class="text-2xl font-bold" id="profileName">Пользователь</div>
          <div class="text-muted-gray" id="profileId">ID: 0</div>
        </div>
        <div class="mb-4 text-muted-gray">
          Текущая скидка: <span id="discountValue">0 ₽</span>
        </div>
        <div class="flex flex-col gap-3">
          <button id="profilePayBtn" class="ios-active border border-primary text-primary font-bold px-4 py-3 rounded-2xl">Поддержать сервис</button>
          <button id="profileRefBtn" class="ios-active border border-primary text-primary font-bold px-4 py-3 rounded-2xl">Реферальная программа</button>
          <button id="profileSupportBtn" class="ios-active border border-primary text-primary font-bold px-4 py-3 rounded-2xl">Связаться с поддержкой</button>
          <button id="profileRulesBtn" class="ios-active border border-primary text-primary font-bold px-4 py-3 rounded-2xl">Устав клуба</button>
          <button id="profileDevicesBtn" class="ios-active bg-primary text-black font-bold px-4 py-3 rounded-2xl">Управление устройствами</button>
        </div>
      </section>

      <section id="screen-support" class="screen">
        <h2 class="text-2xl font-bold mb-2">Поддержка</h2>
        <div class="text-muted-gray mb-4">Откроется чат с ботом.</div>
        <a id="supportLink" class="ios-active bg-primary text-black font-bold px-4 py-3 rounded-2xl inline-block" href="#" target="_blank">Открыть чат</a>
      </section>

      <section id="screen-rules" class="screen">
        <h2 class="text-2xl font-bold mb-2">Устав клуба</h2>
        <div class="text-muted-gray text-sm">
          1. Клуб «Свои для своих». Мы не публичный сервис и держим лимит 50 человек.<br><br>
          2. Уважай канал: без тяжелых торрентов — оставим скорость для работы и игр.<br><br>
          3. Поддержка очага: небольшой взнос — это рукопожатие серверу, чтобы он не гас.<br><br>
          4. Ответственность за инвайт: приглашая друга, ты поручаешься за него.<br><br>
          5. Свобода маневра: ты сам решаешь, сколько устройств тебе нужно — лимит можно менять.
        </div>
      </section>

      <section id="screen-devices" class="screen">
        <h2 class="text-2xl font-bold mb-2">Устройства</h2>
        <div class="text-muted-gray mb-3">Лимит устройств: <span id="deviceLimit">0</span></div>
        <div class="flex flex-col gap-3">
          <button id="resetDeviceBtn" class="ios-active border border-primary text-primary font-bold px-4 py-3 rounded-2xl">Сбросить ключ</button>
          <div class="text-muted-gray text-sm">Сброс ключа отключит все устройства. Затем подключишь нужные заново.</div>
        </div>
      </section>

      <section id="screen-ref" class="screen">
        <h2 class="text-2xl font-bold mb-2">Реферальная программа</h2>
        <div class="text-muted-gray mb-3">Пригласи друга — вход только по инвайтам.</div>
        <div class="bg-card-dark rounded-2xl p-4 break-words" id="refLink">ссылка...</div>
        <button id="copyRefBtn" class="ios-active bg-primary text-black font-bold px-4 py-3 rounded-2xl mt-4">Скопировать ссылку</button>
        <div class="text-muted-gray text-sm mt-3">
          Бонус начисляется только после первой оплаты друга: 15% к твоей скидке.
        </div>
        <div class="mt-4" id="refList"></div>
      </section>

      <section id="screen-admin" class="screen">
        <h2 class="text-2xl font-bold mb-4">Админка</h2>
        <div class="text-muted-gray text-sm mb-4">Управление панелью и клиентами в одном месте.</div>

        <div class="border border-primary rounded-2xl p-4 mb-4">
          <div class="text-white font-bold mb-2">Сервер</div>
          <div class="flex gap-2">
            <button id="adminStats" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl w-full">Статистика</button>
            <button id="adminOnline" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl w-full">Онлайн</button>
          </div>
          <div class="mt-2 text-muted-gray text-sm" id="adminStatsBox">ОЗУ: — | Онлайн: —</div>
          <button id="adminRestart" class="ios-active bg-primary text-black font-bold px-3 py-2 rounded-xl w-full mt-3">Рестарт Xray</button>
        </div>

        <div class="border border-primary rounded-2xl p-4 mb-4">
          <div class="text-white font-bold mb-2">Панель</div>
          <div class="flex gap-2">
            <button id="adminLock" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl w-full">Запереть</button>
            <button id="adminUnlock" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl w-full">Открыть</button>
          </div>
          <div class="mt-3 flex gap-2">
            <input id="adminIp" class="w-full rounded-xl bg-card-dark border border-primary text-white px-3 py-2" placeholder="IP (например 1.2.3.4)" />
            <button id="adminIpShow" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl">IP</button>
          </div>
        </div>

        <div class="border border-primary rounded-2xl p-4 mb-4">
          <div class="text-white font-bold mb-2">Пользователи</div>
          <select id="adminUserId" class="w-full rounded-xl bg-card-dark border border-primary text-white px-3 py-2">
            <option value="">Выбери пользователя</option>
          </select>
          <div class="flex gap-2 mt-3">
            <button id="adminBan" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl w-full">Бан</button>
            <button id="adminUnban" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl w-full">Разбан</button>
            <button id="adminDelete" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl w-full">Удалить</button>
          </div>
          <button id="adminUsersRefresh" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl w-full mt-3">Обновить список пользователей</button>
          <button id="adminAddSlots" class="ios-active bg-primary text-black font-bold px-3 py-2 rounded-xl w-full mt-3">+5 мест</button>
        </div>

        <div class="border border-primary rounded-2xl p-4 mb-4">
          <div class="text-white font-bold mb-2">Клиенты (как в панели)</div>
          <button id="adminClientsRefresh" class="ios-active border border-primary text-primary font-bold px-3 py-2 rounded-xl w-full">Обновить список</button>
          <div class="mt-3 grid grid-cols-2 gap-2">
            <input id="adminClientEmail" class="rounded-xl bg-card-dark border border-primary text-white px-3 py-2 col-span-2" placeholder="Название/Email клиента" />
            <input id="adminClientTgId" class="rounded-xl bg-card-dark border border-primary text-white px-3 py-2" placeholder="tg_id (опц.)" />
            <input id="adminClientLimit" class="rounded-xl bg-card-dark border border-primary text-white px-3 py-2" type="number" min="1" max="50" value="3" />
          </div>
          <button id="adminClientCreate" class="ios-active bg-primary text-black font-bold px-3 py-2 rounded-xl w-full mt-3">Добавить клиента вручную</button>
          <div id="adminClients" class="mt-3 text-sm text-muted-gray">Список пуст</div>
        </div>

        <button id="adminBackup" class="ios-active bg-primary text-black font-bold px-3 py-2 rounded-xl w-full">Бэкап</button>
      </section>
    </main>

    <script>
      const screens = Array.from(document.querySelectorAll('.screen'));
      const backBtn = document.getElementById('backBtn');
      const stack = ['screen-home'];
      let accessClosed = false;

      function showScreen(id) {
        const header = document.getElementById('appHeader');
        const locked = accessClosed && USER_ID !== ADMIN_ID;
        if (locked) id = 'screen-locked';
        screens.forEach(s => s.classList.remove('active'));
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
        backBtn.classList.toggle('hidden', stack.length <= 1);
        if (header) header.classList.toggle('hidden', locked);
      }

      function pushScreen(id) {
        if (accessClosed && USER_ID !== ADMIN_ID) return showScreen('screen-locked');
        stack.push(id);
        showScreen(id);
      }

      function popScreen() {
        if (stack.length > 1) stack.pop();
        showScreen(stack[stack.length - 1]);
      }

      backBtn.addEventListener('click', popScreen);

      const tg = window.Telegram ? Telegram.WebApp : null;
      if (tg) tg.ready();

      const API_BASE = "https://api.112prd.ru:2053";
      const INIT_DATA = tg ? tg.initData : '';
      const ADMIN_ID = 312826672;
      function extractUserId() {
        try {
          if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
            return Number(tg.initDataUnsafe.user.id);
          }
          if (INIT_DATA) {
            const p = new URLSearchParams(INIT_DATA);
            const u = p.get('user');
            if (u) {
              const obj = JSON.parse(u);
              if (obj && obj.id) return Number(obj.id);
            }
          }
        } catch (e) {}
        return 0;
      }
      const USER_ID = extractUserId();

      function apiFetch(path, options = {}) {
        if (!API_BASE) return Promise.reject(new Error('no_api'));
        return fetch(API_BASE + path, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': INIT_DATA,
            ...(options.headers || {})
          }
        }).then(async (r) => {
          const data = await r.json().catch(() => ({}));
          if (!r.ok) {
            const err = new Error(data.detail || 'api_error');
            err.status = r.status;
            err.data = data;
            throw err;
          }
          return data;
        });
      }

      function setSubStatus(active) {
        const el = document.getElementById('subStatus');
        if (active) {
          el.textContent = 'ПОДПИСКА АКТИВНА';
          el.classList.remove('text-accent-red');
          el.classList.add('text-primary');
        } else {
          el.textContent = 'ПОДПИСКА НЕАКТИВНА';
          el.classList.remove('text-primary');
          el.classList.add('text-accent-red');
        }
      }

      let supportUrl = '';

      function loadUser() {
        if (!API_BASE || !INIT_DATA) return;
        apiFetch('/api/user')
          .then(data => {
            document.getElementById('balanceValue').textContent = (data.balance || 0) + '₽';
            document.getElementById('expiryValue').textContent = data.subscription.expiry || 'нет подписки';
            setSubStatus(data.subscription.active);
            document.getElementById('profileName').textContent = data.user.name || 'Пользователь';
            document.getElementById('profileId').textContent = 'ID: ' + data.user.id;
            document.getElementById('deviceLimit').textContent = data.device_limit || 3;
            document.getElementById('refLink').textContent = data.referral_link || 'нет ссылки';
            document.getElementById('discountValue').textContent = data.discount_text || ((data.discount || 0) + ' ₽');
            supportUrl = data.support_link || 'https://t.me/ghostlink112_bot';
            const supportLink = document.getElementById('supportLink');
            supportLink.href = supportUrl;
          })
          .catch((err) => {
            if (err && (err.status === 401 || err.status === 403)) {
              accessClosed = true;
              showScreen('screen-locked');
            }
          });
      }

      function notify(text) {
        const el = document.createElement('div');
        el.className = 'toast';
        el.textContent = text;
        document.body.appendChild(el);
        requestAnimationFrame(() => el.classList.add('show'));
        setTimeout(() => {
          el.classList.remove('show');
          setTimeout(() => el.remove(), 180);
        }, 1800);
      }

      function adminFetch(path, options = {}) {
        return apiFetch(path, options);
      }

      document.getElementById('buyBtn').addEventListener('click', () => pushScreen('screen-tariffs'));
      document.getElementById('profileBtn').addEventListener('click', () => pushScreen('screen-profile'));
      document.getElementById('supportBtn').addEventListener('click', () => pushScreen('screen-support'));

      document.getElementById('profilePayBtn').addEventListener('click', () => pushScreen('screen-tariffs'));
      document.getElementById('profileRefBtn').addEventListener('click', () => { pushScreen('screen-ref'); loadReferrals(); });
      document.getElementById('profileSupportBtn').addEventListener('click', () => pushScreen('screen-support'));
      document.getElementById('profileRulesBtn').addEventListener('click', () => pushScreen('screen-rules'));
      document.getElementById('profileDevicesBtn').addEventListener('click', () => pushScreen('screen-devices'));

      document.getElementById('copyRefBtn').addEventListener('click', async () => {
        const text = document.getElementById('refLink').textContent;
        try { await navigator.clipboard.writeText(text); } catch (e) {}
      });

      document.getElementById('supportLink').addEventListener('click', (e) => {
        if (!supportUrl) return;
        if (tg && tg.openTelegramLink) {
          e.preventDefault();
          tg.openTelegramLink(supportUrl);
        }
      });

      function loadReferrals() {
        apiFetch('/api/referrals')
          .then(data => {
            const box = document.getElementById('refList');
            if (!data.items || data.items.length === 0) {
              box.textContent = 'Пока никого нет.';
              box.className = 'text-muted-gray text-sm';
              return;
            }
            box.innerHTML = '';
            data.items.forEach(item => {
              const row = document.createElement('div');
              row.className = 'flex items-center justify-between py-2 border-b border-white/10 text-sm';
              const status = item.status === 'paid' ? 'Оплачено' : 'Ожидает оплаты';
              row.innerHTML = `<span>${item.name}</span><span class="text-muted-gray">${status}</span>`;
              box.appendChild(row);
            });
          })
          .catch(() => {});
      }

      document.getElementById('resetDeviceBtn').addEventListener('click', () => {
        apiFetch('/api/device/reset', { method: 'POST' }).catch(() => {});
        notify('Запрос на сброс отправлен.');
      });

      document.getElementById('soloPay').addEventListener('click', () => notify('Оплата будет подключена позже.'));
      document.getElementById('flexPay').addEventListener('click', () => notify('Оплата будет подключена позже.'));

      const flexPrices = { 2: 225, 3: 300, 4: 375, 5: 450 };
      const flexSlider = document.getElementById('flexSlider');
      flexSlider.addEventListener('input', () => {
        const v = parseInt(flexSlider.value, 10);
        document.getElementById('flexPrice').textContent = `${v} устройства — ${flexPrices[v]} ₽`;
      });

      if (USER_ID === ADMIN_ID) {
        const adminBtn = document.getElementById('homeAdminBtn');
        adminBtn.classList.remove('hidden');
        adminBtn.addEventListener('click', () => {
          pushScreen('screen-admin');
          loadAdminUsers();
        });
      }

      document.getElementById('adminStats').addEventListener('click', async () => {
        try {
          const data = await adminFetch('/api/admin/stats');
          notify('Статистика обновлена');
          const box = document.getElementById('adminStatsBox');
          box.textContent = `ОЗУ: ${data.free_mem_mb} MB | Онлайн: ${data.online.length} | Места: ${data.total}/${data.max_users}`;
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminOnline').addEventListener('click', async () => {
        try {
          const data = await adminFetch('/api/admin/stats');
          const list = data.online && data.online.length ? data.online.join(', ') : 'онлайн 0';
          notify(list);
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminRestart').addEventListener('click', async () => {
        try {
          await adminFetch('/api/admin/xray/restart', { method: 'POST' });
          notify('Xray перезапущен');
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminLock').addEventListener('click', async () => {
        try {
          const r = await adminFetch('/api/admin/panel/lock', { method: 'POST' });
          notify(r.message || 'Панель закрыта');
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminUnlock').addEventListener('click', async () => {
        const ip = document.getElementById('adminIp').value.trim();
        if (!ip) return notify('Укажи IP');
        try {
          const r = await adminFetch('/api/admin/panel/unlock', { method: 'POST', body: JSON.stringify({ ip }) });
          notify(r.message || 'Панель открыта');
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminIpShow').addEventListener('click', async () => {
        try {
          const r = await adminFetch('/api/admin/myip');
          notify(`Твой IP: ${r.ip || '-'}`);
          if (r.ip) document.getElementById('adminIp').value = r.ip;
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminAddSlots').addEventListener('click', async () => {
        try {
          const r = await adminFetch('/api/admin/add_slots', { method: 'POST' });
          notify(`Новый лимит: ${r.max_users}`);
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminBan').addEventListener('click', async () => {
        const userId = document.getElementById('adminUserId').value.trim();
        if (!userId) return notify('Укажи Telegram ID');
        try {
          await adminFetch('/api/admin/user/ban', { method: 'POST', body: JSON.stringify({ user_id: userId }) });
          notify('Пользователь забанен');
          loadAdminUsers();
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminUnban').addEventListener('click', async () => {
        const userId = document.getElementById('adminUserId').value.trim();
        if (!userId) return notify('Укажи Telegram ID');
        try {
          await adminFetch('/api/admin/user/unban', { method: 'POST', body: JSON.stringify({ user_id: userId }) });
          notify('Пользователь разблокирован');
          loadAdminUsers();
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminDelete').addEventListener('click', async () => {
        const userId = document.getElementById('adminUserId').value.trim();
        if (!userId) return notify('Укажи Telegram ID');
        try {
          await adminFetch('/api/admin/user/delete', { method: 'POST', body: JSON.stringify({ user_id: userId }) });
          notify('Пользователь удален');
          loadAdminUsers();
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminUsersRefresh').addEventListener('click', loadAdminUsers);

      document.getElementById('adminClientCreate').addEventListener('click', async () => {
        const email = document.getElementById('adminClientEmail').value.trim();
        const tgId = document.getElementById('adminClientTgId').value.trim();
        const limit = parseInt(document.getElementById('adminClientLimit').value || '3', 10);
        if (!email) return notify('Укажи название/email клиента');
        try {
          await adminFetch('/api/admin/client/create', {
            method: 'POST',
            body: JSON.stringify({ email: email, tg_id: tgId || 'manual', limit: limit })
          });
          notify('Клиент добавлен');
          document.getElementById('adminClientEmail').value = '';
          loadAdminClients();
        } catch (e) {
          notify('Ошибка');
        }
      });
      document.getElementById('adminBackup').addEventListener('click', async () => {
        try {
          const resp = await fetch(API_BASE + '/api/admin/backup', {
            headers: { 'X-Telegram-InitData': INIT_DATA }
          });
          if (!resp.ok) throw new Error('backup_error');
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'ghostlink-backup.db';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          notify('Бэкап скачан');
        } catch (e) {
          notify('Ошибка');
        }
      });

      function formatBytes(val) {
        const v = Number(val || 0);
        if (v < 1024) return v + ' B';
        const kb = v / 1024;
        if (kb < 1024) return kb.toFixed(1) + ' KB';
        const mb = kb / 1024;
        if (mb < 1024) return mb.toFixed(1) + ' MB';
        const gb = mb / 1024;
        return gb.toFixed(2) + ' GB';
      }

      async function loadAdminClients() {
        const box = document.getElementById('adminClients');
        box.textContent = 'Загрузка...';
        try {
          const data = await adminFetch('/api/admin/clients');
          if (!data.items || data.items.length === 0) {
            box.textContent = 'Список пуст';
            return;
          }
          box.innerHTML = '';
          data.items.forEach(item => {
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between gap-2 py-2 border-b border-white/10';
            const left = document.createElement('div');
            left.className = 'flex flex-col';
            const name = document.createElement('div');
            name.className = 'text-white';
            name.textContent = item.email || item.uuid;
            const meta = document.createElement('div');
            meta.className = 'text-muted-gray text-xs';
            meta.textContent = `${item.online ? 'Онлайн' : 'Офлайн'} · ${formatBytes(item.total || 0)}`;
            left.appendChild(name);
            left.appendChild(meta);

            const right = document.createElement('div');
            right.className = 'flex gap-2';
            const toggle = document.createElement('button');
            toggle.className = 'ios-active border border-primary text-primary font-bold px-2 py-1 rounded-lg text-xs';
            toggle.textContent = item.enable ? 'Откл' : 'Вкл';
            toggle.addEventListener('click', async () => {
              try {
                await adminFetch('/api/admin/client/enable', {
                  method: 'POST',
                  body: JSON.stringify({ uuid: item.uuid, enable: !item.enable })
                });
                notify('Сохранено');
                loadAdminClients();
              } catch (e) {
                notify('Ошибка');
              }
            });
            const del = document.createElement('button');
            del.className = 'ios-active border border-primary text-primary font-bold px-2 py-1 rounded-lg text-xs';
            del.textContent = 'Удалить';
            del.addEventListener('click', async () => {
              try {
                await adminFetch('/api/admin/client/delete', {
                  method: 'POST',
                  body: JSON.stringify({ uuid: item.uuid })
                });
                notify('Удалено');
                loadAdminClients();
              } catch (e) {
                notify('Ошибка');
              }
            });
            right.appendChild(toggle);
            right.appendChild(del);

            row.appendChild(left);
            row.appendChild(right);
            box.appendChild(row);
          });
        } catch (e) {
          box.textContent = 'Ошибка загрузки';
        }
      }

      document.getElementById('adminClientsRefresh').addEventListener('click', loadAdminClients);

      async function loadAdminUsers() {
        const sel = document.getElementById('adminUserId');
        if (!sel) return;
        try {
          const data = await adminFetch('/api/admin/users');
          sel.innerHTML = '<option value="">Выбери пользователя</option>';
          (data.items || []).forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = `${u.name} (${u.id}) [${u.status}]`;
            sel.appendChild(opt);
          });
          notify('Список пользователей обновлен');
        } catch (e) {
          notify('Ошибка загрузки пользователей');
        }
      }

      loadUser();
    </script>
  </body>
</html>
